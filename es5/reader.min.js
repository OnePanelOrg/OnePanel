/**
 * @license MIT License
 *
 * Copyright (c) 2016 Rick Lancee @ricklancee
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||false;a.configurable=true;if("value"in a)a.writable=true;Object.defineProperty(e,a.key,a)}}return function(t,n,a){if(n)e(t.prototype,n);if(a)e(t,a);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(e,t){if(!e){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return t&&(typeof t==="object"||typeof t==="function")?t:e}function _inherits(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof t)}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:false,writable:true,configurable:true}});if(t)Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t}var MangaReader=function(e){_inherits(t,e);function t(){_classCallCheck(this,t);return _possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}_createClass(t,[{key:"createdCallback",value:function e(){var t=this;this.dataFileUri=this.getAttribute("data");if(!this.dataFileUri){return}this.basePath=this.dataFileUri.substring(0,this.dataFileUri.lastIndexOf("data.json"));this.data=null;this.pages=null;this.currentPageIndex=0;this.currentPanelIndex=0;this.canvasEl=null;this.canvas=null;this._fitscreen=false;this._opacity=.025;this._fitPanels=false;this._preloadPages=true;this._appendBasePath=true;this.pageDimensions=null;this.screenWidth=window.innerWidth;this.screenHeight=window.innerHeight;this.loadedEvent=new CustomEvent("loaded");this._createCanvas();this._addEventListeners();this._loadingTimer=window.setTimeout(this._showLoading.bind(this),300);this._loadData(this.dataFileUri).then(function(e){t.data=e;t.pages=t.data.pages;t._createPagination();var n=t._getPaginationFromHash();if(n){t.currentPageIndex=n[0];t.currentPanelIndex=n[1]}t._setPage(t.currentPageIndex).then(function(e){t._drawPanels(t.currentPanelIndex);t._setPaginationHash();t._setActivePagination();t._positionView();if(t._preloadPages){t._preloadNextPage()}if(t._loadingTimer){window.clearTimeout(t._loadingTimer);t._hideLoading();t._loadingTimer=null}t.dispatchEvent(t.loadedEvent)})})}},{key:"_getPaginationFromHash",value:function e(){var t=window.location.hash.match(/(\d+)-(\d+)/);if(!t)return false;var n=Math.min(Math.max(parseInt(parseInt(t[1])-1),0),this.pages.length-1);var a=this.pages[n].panels.length-1;var i=Math.min(Math.max(parseInt(parseInt(t[2])-1),0),a);return[n,i]}},{key:"_setPaginationHash",value:function e(){var t=this.currentPageIndex+1;var n=this.currentPanelIndex+1;if(t<10)t="0"+t;if(n<10)n="0"+n;window.history.replaceState({},null,"#"+t+"-"+n)}},{key:"_setActivePagination",value:function e(){Array.from(this.querySelectorAll(".pagination a")).forEach(function(e){return e.classList.remove("active")});Array.from(this.querySelectorAll('.pagination a[data-index="'+this.currentPageIndex+'"]')).forEach(function(e){return e.classList.add("active")})}},{key:"_addEventListeners",value:function e(){var t=this;window.addEventListener("resize",function(e){t._recalcPage()});this.canvasEl.addEventListener("click",function(e){t.nextPanel()});window.addEventListener("keydown",function(e){if(e.keyCode===39){t.nextPanel();e.preventDefault()}if(e.keyCode===37){t.previousPanel();e.preventDefault()}});window.addEventListener("hashchange",function(e){window.location.reload()})}},{key:"_showLoading",value:function e(){var t=document.createElement("div");t.classList.add("manga-reader__spinner");this.appendChild(t)}},{key:"_hideLoading",value:function e(){var t=document.querySelector(".manga-reader__spinner");if(t){t.remove()}}},{key:"_recalcPage",value:function e(){this.screenHeight=window.innerHeight;this.screenWidth=window.innerWidth;var t=this.canvasEl.getBoundingClientRect();this.pageDimensions={top:t.top+window.scrollY,left:t.left+window.scrollX,width:t.width,height:t.height}}},{key:"fitscreen",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;if(t){this.canvasEl.style.height=this.screenHeight+"px";this.canvasEl.style.width="auto"}else{this.canvasEl.style.height="";this.canvasEl.style.width=""}}},{key:"_loadData",value:function e(t){return fetch(t).then(function(e){return e.json()})}},{key:"_loadImage",value:function e(t){try{new URL(t)}catch(e){if(this._appendBasePath){t=this.basePath+t}}return new Promise(function(e,n){var a=new Image;a.onload=function(){e(a)};a.onerror=function(e){n('Failed to load image with uri: "'+t+'"')};a.src=t})}},{key:"_preloadNextPage",value:function e(){if(this.currentPageIndex==this.pages.length-1){return}var t=this.currentPageIndex+1;var n=this.pages[t].image;this._loadImage(n).then(function(e){console.log("preloaded page: "+(t+1))})}},{key:"_createCanvas",value:function e(){if(this.canvasEl){return}var t=document.createElement("canvas");this.canvasEl=t;this.canvas=t.getContext("2d");this.appendChild(t)}},{key:"_createPagination",value:function e(){var t=document.createElement("ol");t.classList.add("pagination");var n=this.pages.length;for(var a=0;a<n;a++){var i=document.createElement("li");var s=document.createElement("a");var r=a+1<10?"0"+(a+1):a+1;s.innerHTML=r;s.classList.add("pagination-link");s.setAttribute("data-index",a);s.href="#"+r+"-01";i.appendChild(s);t.appendChild(i)}this.insertBefore(t,this.firstChild);this.appendChild(t.cloneNode(true))}},{key:"_setPage",value:function e(t){var n=this;var a=this.pages[t].image;this.canvas.clearRect(0,0,this.canvasEl.width,this.canvasEl.height);return this._loadImage(a).then(function(e){n.currentImage=e;n._drawPage(e);n._recalcPage()})}},{key:"_drawPage",value:function e(t){this.canvas.save();this.canvasEl.width=t.width;this.canvasEl.height=t.height;this.canvas.globalAlpha=this._opacity;this.canvas.drawImage(t,0,0);this.canvas.globalAlpha=1;this.canvas.restore()}},{key:"_drawPanels",value:function e(t){var n=this.pages[this.currentPageIndex].panels.length;var a=Math.min(Math.max(parseInt(t+1),0),n);for(var i=0;i<a;i++){this._drawPanel(i)}}},{key:"_drawPanel",value:function e(t){var n=this.pages[this.currentPageIndex].panels[t].path.split(",");var a=n.length;this.canvas.save();this.canvas.beginPath();for(var i=0;i<a;i++){var s=n[i].trim().split(" ");var r=s[0]*this.canvasEl.width/100;var h=s[1]*this.canvasEl.height/100;if(a==0){this.canvas.moveTo(r,h)}else{this.canvas.lineTo(r,h)}}this.canvas.closePath();this.canvas.clip();this.canvas.drawImage(this.currentImage,0,0);this.canvas.restore()}},{key:"nextPanel",value:function e(){var t=this.pages[this.currentPageIndex].panels.length-1;this.currentPanelIndex++;if(this.currentPanelIndex>t){if(this.currentPageIndex<this.pages.length-1){this.nextPage();console.log("Go to next page");return}console.log("Last panel");this.currentPanelIndex=t;return}this._drawPage(this.currentImage);this._drawPanels(this.currentPanelIndex);this._setPaginationHash();this._positionView()}},{key:"previousPanel",value:function e(){this.currentPanelIndex--;if(this.currentPanelIndex<0){if(this.currentPageIndex>0){this.previousPage();console.log("go to previous page");return}console.log("First panel");this.currentPanelIndex=0;return}this._drawPage(this.currentImage);this._drawPanels(this.currentPanelIndex);this._setPaginationHash();this._positionView()}},{key:"nextPage",value:function e(){var t=this;if(this.currentPageIndex===this.pages.length-1){return Promise.resolve()}this.currentPageIndex++;this.currentPanelIndex=0;this._loadingTimer=window.setTimeout(this._showLoading.bind(this),300);return this._setPage(this.currentPageIndex).then(function(e){if(t._loadingTimer){window.clearTimeout(t._loadingTimer);t._loadingTimer=null;t._hideLoading()}t._drawPanels(t.currentPanelIndex);t._setPaginationHash();t._setActivePagination();t._positionView();if(t._preloadPages){t._preloadNextPage()}})}},{key:"previousPage",value:function e(){var t=this;if(this.currentPageIndex===0){return Promise.resolve()}this.currentPageIndex--;this.currentPanelIndex=this.pages[this.currentPageIndex].panels.length-1;return this._setPage(this.currentPageIndex).then(function(e){t._drawPanels(t.currentPanelIndex);t._setPaginationHash();t._setActivePagination();t._positionView()})}},{key:"_positionView",value:function e(){var t=this.pages[this.currentPageIndex].panels[this.currentPanelIndex];if(!t){return}this._recalcPage();var n=this.pageDimensions.top-15;var a=this.pageDimensions.left-15;var i=t.y*this.pageDimensions.height/100+n;var s=t.x*this.pageDimensions.width/100+a;var r=t.height*this.pageDimensions.height/100;if(this._fitscreen){this.fitscreen(true)}else if(this.pages[this.currentPageIndex].fitscreen){this.fitscreen(true)}else if(this._fitPanels&&r>this.screenHeight){console.log("auto resize");var h=this.screenHeight;var o=this.pageDimensions.height*((this.screenHeight-this.pageDimensions.top)/r);this.canvasEl.style.height=o+"px";this.canvasEl.style.width="auto"}else{this.canvasEl.style.height="";this.canvasEl.style.width=""}this._recalcPage();window.scrollTo(s,i)}}]);return t}(HTMLElement);